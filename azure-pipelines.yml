trigger:
  branches:
    include:
    - main

pr:
  branches:
    include:
    - main

resources:
  - repo: self

variables:
  backendImageName: 'legis-vue-backend'
  frontendImageName: 'legis-vue-frontend'
  tag: '$(Build.BuildId)'
  vmImageName: 'ubuntu-latest'
  azureSubscription: 'da3b208d-e23d-4e3b-8901-1ee297dd91f0'
  containerRegistry: 'moregroupdev.azurecr.io'
  resourceGroupName: 'rg-legislation-tracker'
  backendContainerAppName: 'legis-vue-backend'
  frontendContainerAppName: 'legis-vue-frontend'
  keyVaultName: 'kv-legislation-tracker'

stages:
- stage: Build
  displayName: Build and Push
  jobs:
  - job: BuildBackend
    displayName: Build Backend
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: AzureCLI@2
      displayName: Build and Push Backend Image
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          # Login to ACR
          az acr login --name moregroupdev
          
          # Build image with platform specification
          docker build --platform linux/amd64 -t $(containerRegistry)/$(backendImageName):$(tag) -t $(containerRegistry)/$(backendImageName):latest ./backend
          
          # Push image
          docker push $(containerRegistry)/$(backendImageName):$(tag)
          docker push $(containerRegistry)/$(backendImageName):latest

  - job: BuildFrontend
    displayName: Build Frontend
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: AzureCLI@2
      displayName: Build and Push Frontend Image
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          # Login to ACR
          az acr login --name moregroupdev
          
          # Build image with platform specification
          docker build --platform linux/amd64 -t $(containerRegistry)/$(frontendImageName):$(tag) -t $(containerRegistry)/$(frontendImageName):latest ./frontend
          
          # Push image
          docker push $(containerRegistry)/$(frontendImageName):$(tag)
          docker push $(containerRegistry)/$(frontendImageName):latest

- stage: Deploy
  displayName: Deploy to Container Apps
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: DeployBackend
    displayName: Deploy Backend
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: AzureCLI@2
      displayName: Deploy Backend to Container App
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          # Get current environment configuration
          CURRENT_ENV=$(az containerapp show --name $(backendContainerAppName) --resource-group $(resourceGroupName) --query "properties.template.containers[0].env" -o json)
          
          # Update with new image
          az containerapp update \
            --name $(backendContainerAppName) \
            --resource-group $(resourceGroupName) \
            --container-name $(backendContainerAppName) \
            --image $(containerRegistry)/$(backendImageName):$(tag)
          
          # Set Key Vault reference for each secret
          echo "Setting Key Vault references for backend..."
          
          # Create JSON template for key vault references
          cat > backend-kv-refs.json << EOF
          {
            "properties": {
              "configuration": {
                "secrets": [
                  {
                    "name": "frontend-url",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/FRONTEND-URL"
                  },
                  {
                    "name": "azure-endpoint",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/AZURE-ENDPOINT"
                  },
                  {
                    "name": "azure-key",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/AZURE-KEY"
                  },
                  {
                    "name": "azure-model-name",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/AZURE-MODEL-NAME"
                  },
                  {
                    "name": "azure-sql-database",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/AZURE-SQL-DATABASE"
                  },
                  {
                    "name": "azure-sql-password",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/AZURE-SQL-PASSWORD"
                  },
                  {
                    "name": "azure-sql-server",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/AZURE-SQL-SERVER"
                  },
                  {
                    "name": "azure-sql-username",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/AZURE-SQL-USERNAME"
                  },
                  {
                    "name": "debug-mode",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/DEBUG-MODE"
                  },
                  {
                    "name": "environment",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/ENVIRONMENT"
                  },
                  {
                    "name": "from-email",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/FROM-EMAIL"
                  },
                  {
                    "name": "legiscan-api-key",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/LEGISCAN-API-KEY"
                  },
                  {
                    "name": "managed-identity-client-id",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/MANAGED-IDENTITY-CLIENT-ID"
                  },
                  {
                    "name": "sendgrid-api-key",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/SENDGRID-API-KEY"
                  },
                  {
                    "name": "sql-echo",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/SQL-ECHO"
                  },
                  {
                    "name": "vite-api-url",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/VITE-API-URL"
                  },
                  {
                    "name": "vite-api-url-prod",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/VITE-API-URL-PROD"
                  },
                  {
                    "name": "vite-azure-client-id",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/VITE-AZURE-CLIENT-ID"
                  },
                  {
                    "name": "vite-azure-tenant-id",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/VITE-AZURE-TENANT-ID"
                  }
                ]
              },
              "template": {
                "containers": [
                  {
                    "name": "$(backendContainerAppName)",
                    "env": [
                      {
                        "name": "PYTHONUNBUFFERED",
                        "value": "1"
                      },
                      {
                        "name": "FRONTEND_URL",
                        "secretRef": "frontend-url"
                      },
                      {
                        "name": "AZURE_ENDPOINT",
                        "secretRef": "azure-endpoint"
                      },
                      {
                        "name": "AZURE_KEY",
                        "secretRef": "azure-key"
                      },
                      {
                        "name": "AZURE_MODEL_NAME",
                        "secretRef": "azure-model-name"
                      },
                      {
                        "name": "AZURE_SQL_DATABASE",
                        "secretRef": "azure-sql-database"
                      },
                      {
                        "name": "AZURE_SQL_PASSWORD",
                        "secretRef": "azure-sql-password"
                      },
                      {
                        "name": "AZURE_SQL_SERVER",
                        "secretRef": "azure-sql-server"
                      },
                      {
                        "name": "AZURE_SQL_USERNAME",
                        "secretRef": "azure-sql-username"
                      },
                      {
                        "name": "DEBUG_MODE",
                        "secretRef": "debug-mode"
                      },
                      {
                        "name": "ENVIRONMENT",
                        "secretRef": "environment"
                      },
                      {
                        "name": "FROM_EMAIL",
                        "secretRef": "from-email"
                      },
                      {
                        "name": "LEGISCAN_API_KEY",
                        "secretRef": "legiscan-api-key"
                      },
                      {
                        "name": "MANAGED_IDENTITY_CLIENT_ID",
                        "secretRef": "managed-identity-client-id"
                      },
                      {
                        "name": "SENDGRID_API_KEY",
                        "secretRef": "sendgrid-api-key"
                      },
                      {
                        "name": "SQL_ECHO",
                        "secretRef": "sql-echo"
                      },
                      {
                        "name": "VITE_API_URL",
                        "secretRef": "vite-api-url"
                      },
                      {
                        "name": "VITE_API_URL_PROD",
                        "secretRef": "vite-api-url-prod"
                      },
                      {
                        "name": "VITE_AZURE_CLIENT_ID",
                        "secretRef": "vite-azure-client-id"
                      },
                      {
                        "name": "VITE_AZURE_TENANT_ID",
                        "secretRef": "vite-azure-tenant-id"
                      }
                    ]
                  }
                ]
              }
            }
          }
          EOF
          
          # Apply configuration using ARM template format
          az containerapp update \
            --name $(backendContainerAppName) \
            --resource-group $(resourceGroupName) \
            --set-env-vars "PYTHONUNBUFFERED=1"
          
          echo "Updating backend with Key Vault references..."
          az resource update \
            --resource-group $(resourceGroupName) \
            --name $(backendContainerAppName) \
            --resource-type "Microsoft.App/containerApps" \
            --set @backend-kv-refs.json
          
  - job: DeployFrontend
    displayName: Deploy Frontend
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: AzureCLI@2
      displayName: Deploy Frontend to Container App
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          # Update with new image
          az containerapp update \
            --name $(frontendContainerAppName) \
            --resource-group $(resourceGroupName) \
            --container-name $(frontendContainerAppName) \
            --image $(containerRegistry)/$(frontendImageName):$(tag)
          
          # Set Key Vault reference for each secret
          echo "Setting Key Vault references for frontend..."
          
          # Create JSON template for key vault references
          cat > frontend-kv-refs.json << EOF
          {
            "properties": {
              "configuration": {
                "secrets": [
                  {
                    "name": "frontend-url",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/FRONTEND-URL"
                  },
                  {
                    "name": "azure-endpoint",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/AZURE-ENDPOINT"
                  },
                  {
                    "name": "azure-key",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/AZURE-KEY"
                  },
                  {
                    "name": "azure-model-name",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/AZURE-MODEL-NAME"
                  },
                  {
                    "name": "azure-sql-database",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/AZURE-SQL-DATABASE"
                  },
                  {
                    "name": "azure-sql-password",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/AZURE-SQL-PASSWORD"
                  },
                  {
                    "name": "azure-sql-server",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/AZURE-SQL-SERVER"
                  },
                  {
                    "name": "azure-sql-username",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/AZURE-SQL-USERNAME"
                  },
                  {
                    "name": "debug-mode",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/DEBUG-MODE"
                  },
                  {
                    "name": "environment",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/ENVIRONMENT"
                  },
                  {
                    "name": "from-email",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/FROM-EMAIL"
                  },
                  {
                    "name": "legiscan-api-key",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/LEGISCAN-API-KEY"
                  },
                  {
                    "name": "managed-identity-client-id",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/MANAGED-IDENTITY-CLIENT-ID"
                  },
                  {
                    "name": "sendgrid-api-key",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/SENDGRID-API-KEY"
                  },
                  {
                    "name": "sql-echo",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/SQL-ECHO"
                  },
                  {
                    "name": "vite-api-url",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/VITE-API-URL"
                  },
                  {
                    "name": "vite-api-url-prod",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/VITE-API-URL-PROD"
                  },
                  {
                    "name": "vite-azure-client-id",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/VITE-AZURE-CLIENT-ID"
                  },
                  {
                    "name": "vite-azure-tenant-id",
                    "keyVaultUrl": "https://$(keyVaultName).vault.azure.net/secrets/VITE-AZURE-TENANT-ID"
                  }
                ]
              },
              "template": {
                "containers": [
                  {
                    "name": "$(frontendContainerAppName)",
                    "env": [
                      {
                        "name": "FRONTEND_URL",
                        "secretRef": "frontend-url"
                      },
                      {
                        "name": "AZURE_ENDPOINT",
                        "secretRef": "azure-endpoint"
                      },
                      {
                        "name": "AZURE_KEY",
                        "secretRef": "azure-key"
                      },
                      {
                        "name": "AZURE_MODEL_NAME",
                        "secretRef": "azure-model-name"
                      },
                      {
                        "name": "AZURE_SQL_DATABASE",
                        "secretRef": "azure-sql-database"
                      },
                      {
                        "name": "AZURE_SQL_PASSWORD",
                        "secretRef": "azure-sql-password"
                      },
                      {
                        "name": "AZURE_SQL_SERVER",
                        "secretRef": "azure-sql-server"
                      },
                      {
                        "name": "AZURE_SQL_USERNAME",
                        "secretRef": "azure-sql-username"
                      },
                      {
                        "name": "DEBUG_MODE",
                        "secretRef": "debug-mode"
                      },
                      {
                        "name": "ENVIRONMENT",
                        "secretRef": "environment"
                      },
                      {
                        "name": "FROM_EMAIL",
                        "secretRef": "from-email"
                      },
                      {
                        "name": "LEGISCAN_API_KEY",
                        "secretRef": "legiscan-api-key"
                      },
                      {
                        "name": "MANAGED_IDENTITY_CLIENT_ID",
                        "secretRef": "managed-identity-client-id"
                      },
                      {
                        "name": "SENDGRID_API_KEY",
                        "secretRef": "sendgrid-api-key"
                      },
                      {
                        "name": "SQL_ECHO",
                        "secretRef": "sql-echo"
                      },
                      {
                        "name": "VITE_API_URL",
                        "secretRef": "vite-api-url"
                      },
                      {
                        "name": "VITE_API_URL_PROD",
                        "secretRef": "vite-api-url-prod"
                      },
                      {
                        "name": "VITE_AZURE_CLIENT_ID",
                        "secretRef": "vite-azure-client-id"
                      },
                      {
                        "name": "VITE_AZURE_TENANT_ID",
                        "secretRef": "vite-azure-tenant-id"
                      }
                    ]
                  }
                ]
              }
            }
          }
          EOF
          
          echo "Updating frontend with Key Vault references..."
          az resource update \
            --resource-group $(resourceGroupName) \
            --name $(frontendContainerAppName) \
            --resource-type "Microsoft.App/containerApps" \
            --set @frontend-kv-refs.json
