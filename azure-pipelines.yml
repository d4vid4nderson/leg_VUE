trigger:
  branches:
    include:
    - main

pr:
  branches:
    include:
    - main

resources:
  - repo: self

variables:
  # These non-secret variables can remain as pipeline variables
  backendImageName: 'legis-vue-backend'
  frontendImageName: 'legis-vue-frontend'
  tag: '$(Build.BuildId)'
  vmImageName: 'ubuntu-latest'
  azureSubscription: 'da3b208d-e23d-4e3b-8901-1ee297dd91f0'
  containerRegistry: 'moregroupdev.azurecr.io'
  resourceGroupName: 'rg-legislation-tracker'
  backendContainerAppName: 'legis-vue-backend'
  frontendContainerAppName: 'legis-vue-frontend'
  keyVaultName: 'kv-legislation-tracker'

stages:
- stage: Build
  displayName: Build and Push
  jobs:
  - job: BuildBackend
    displayName: Build Backend
    pool:
      vmImage: $(vmImageName)
    steps:
    # Access Key Vault secrets at the beginning of the pipeline
    - task: AzureKeyVault@2
      displayName: 'Fetch secrets from Azure Key Vault'
      inputs:
        azureSubscription: $(azureSubscription)
        KeyVaultName: $(keyVaultName)
        SecretsFilter: '*'
        RunAsPreJob: true  # Run this before other tasks to make secrets available

    - task: AzureCLI@2
      displayName: Build and Push Backend Image
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          # Login to ACR
          az acr login --name moregroupdev
          
          # Build image with platform specification
          docker build --platform linux/amd64 -t $(containerRegistry)/$(backendImageName):$(tag) -t $(containerRegistry)/$(backendImageName):latest ./backend
          
          # Push image
          docker push $(containerRegistry)/$(backendImageName):$(tag)
          docker push $(containerRegistry)/$(backendImageName):latest

  - job: BuildFrontend
    displayName: Build Frontend
    pool:
      vmImage: $(vmImageName)
    steps:
    # Access Key Vault secrets for this job as well
    - task: AzureKeyVault@2
      displayName: 'Fetch secrets from Azure Key Vault'
      inputs:
        azureSubscription: $(azureSubscription)
        KeyVaultName: $(keyVaultName)
        SecretsFilter: '*'
        RunAsPreJob: true  # Run this before other tasks to make secrets available

    - task: AzureCLI@2
      displayName: Build and Push Frontend Image
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          # Login to ACR
          az acr login --name moregroupdev
          
          # Build image with platform specification
          docker build --platform linux/amd64 -t $(containerRegistry)/$(frontendImageName):$(tag) -t $(containerRegistry)/$(frontendImageName):latest ./frontend
          
          # Push image
          docker push $(containerRegistry)/$(frontendImageName):$(tag)
          docker push $(containerRegistry)/$(frontendImageName):latest

- stage: Deploy
  displayName: Deploy to Container Apps
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: DeployBackend
    displayName: Deploy Backend
    pool:
      vmImage: $(vmImageName)
    steps:
    # Access Key Vault secrets for this job
    - task: AzureKeyVault@2
      displayName: 'Fetch secrets from Azure Key Vault'
      inputs:
        azureSubscription: $(azureSubscription)
        KeyVaultName: $(keyVaultName)
        SecretsFilter: '*'
        RunAsPreJob: true  # Run this before other tasks to make secrets available

    - task: AzureCLI@2
      displayName: Deploy Backend to Container App
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          # Update container app with new image
          echo "Updating backend container app with new image..."
          az containerapp update \
            --name $(backendContainerAppName) \
            --resource-group $(resourceGroupName) \
            --container-name $(backendContainerAppName) \
            --image $(containerRegistry)/$(backendImageName):$(tag)
          
          # Add environment variables directly to the container app
          echo "Configuring backend environment variables..."
          
          # Set all variables using Key Vault secrets
          # The syntax $(SECRET-NAME) accesses the secret values loaded from Key Vault
          az containerapp update \
            --name $(backendContainerAppName) \
            --resource-group $(resourceGroupName) \
            --set-env-vars \
            "ENVIRONMENT=$(ENVIRONMENT)" \
            "AZURE_ENDPOINT=$(AZURE-ENDPOINT)" \
            "AZURE_KEY=$(AZURE-KEY)" \
            "AZURE_MODEL_NAME=$(AZURE-MODEL-NAME)" \
            "AZURE_SQL_SERVER=$(AZURE-SQL-SERVER)" \
            "AZURE_SQL_DATABASE=$(AZURE-SQL-DATABASE)" \
            "AZURE_SQL_USERNAME=$(AZURE-SQL-USERNAME)" \
            "AZURE_SQL_PASSWORD=$(AZURE-SQL-PASSWORD)" \
            "LEGISCAN_API_KEY=$(LEGISCAN-API-KEY)" \
            "FRONTEND_URL=$(FRONTEND-URL)" \
            "MANAGED_IDENTITY_CLIENT_ID=$(MANAGED-IDENTITY-CLIENT-ID)" \
            "DEBUG_MODE=$(DEBUG-MODE)" \
            "FROM_EMAIL=$(FROM-EMAIL)" \
            "SENDGRID_API_KEY=$(SENDGRID-API-KEY)" \
            "SQL_ECHO=$(SQL-ECHO)" \
            "VITE_API_URL=$(VITE-API-URL)" \
            "VITE_API_URL_PROD=$(VITE-API-URL-PROD)" \
            "VITE_AZURE_CLIENT_ID=$(VITE-AZURE-CLIENT-ID)" \
            "VITE_AZURE_TENANT_ID=$(VITE-AZURE-TENANT-ID)" \
            "PYTHONUNBUFFERED=1"
          
          echo "Backend container app updated successfully."

  - job: DeployFrontend
    displayName: Deploy Frontend
    pool:
      vmImage: $(vmImageName)
    steps:
    # Access Key Vault secrets for this job
    - task: AzureKeyVault@2
      displayName: 'Fetch secrets from Azure Key Vault'
      inputs:
        azureSubscription: $(azureSubscription)
        KeyVaultName: $(keyVaultName)
        SecretsFilter: '*'
        RunAsPreJob: true  # Run this before other tasks to make secrets available

    - task: AzureCLI@2
      displayName: Deploy Frontend to Container App
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          # Update container app with new image
          echo "Updating frontend container app with new image..."
          az containerapp update \
            --name $(frontendContainerAppName) \
            --resource-group $(resourceGroupName) \
            --container-name $(frontendContainerAppName) \
            --image $(containerRegistry)/$(frontendImageName):$(tag)
          
          # Add environment variables directly to the container app  
          echo "Configuring frontend environment variables..."
          
          # Set all variables using Key Vault secrets
          az containerapp update \
            --name $(frontendContainerAppName) \
            --resource-group $(resourceGroupName) \
            --set-env-vars \
            "ENVIRONMENT=$(ENVIRONMENT)" \
            "FRONTEND_URL=$(FRONTEND-URL)" \
            "VITE_API_URL=$(VITE-API-URL)" \
            "VITE_API_URL_PROD=$(VITE-API-URL-PROD)" \
            "VITE_AZURE_CLIENT_ID=$(VITE-AZURE-CLIENT-ID)" \
            "VITE_AZURE_TENANT_ID=$(VITE-AZURE-TENANT-ID)"
          
          echo "Frontend container app updated successfully."

- stage: Test
  displayName: Test Deployed Environment
  dependsOn: Deploy
  condition: succeeded()
  jobs:
  - job: TestDeployedBackend
    displayName: Test Backend Connectivity
    pool:
      vmImage: $(vmImageName)
    steps:
    # Access Key Vault secrets for this job
    - task: AzureKeyVault@2
      displayName: 'Fetch secrets from Azure Key Vault'
      inputs:
        azureSubscription: $(azureSubscription)
        KeyVaultName: $(keyVaultName)
        SecretsFilter: '*'
        RunAsPreJob: true  # Run this before other tasks to make secrets available

    - task: AzureCLI@2
      displayName: Run Test Script in Container
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          # Wait for deployments to stabilize
          echo "Waiting for deployments to stabilize..."
          sleep 30
          
          # Run the test script that's already in the container
          echo "Running test_prod.py in the backend container..."
          
          # Use bash -c to execute the command non-interactively
          az containerapp exec \
            --name $(backendContainerAppName) \
            --resource-group $(resourceGroupName) \
            --command "bash -c 'python test_prod.py; echo \$? > /tmp/exit_code; cat /tmp/exit_code'" \
            --output tsv
          
          # Check if the command failed
          if [ $? -ne 0 ]; then
            echo "##vso[task.complete result=Failed;]Failed to execute command in container"
            exit 1
          fi
